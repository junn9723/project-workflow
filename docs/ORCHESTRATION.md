# AIエージェント オーケストレーション設計

このドキュメントは、複数エージェントを安定運用するための**実行ループ・役割分担・成果物管理**を定義する。

---

## 1. 役割と責務

### 1-1. オーケストレータ（ClaudeCode）
- **設計・分割**: Specから独立タスクを設計しジョブパケット化
- **割当**: 作業の重さに応じてClaudeCode/Codex/Agent Teamsへ配分
- **品質ゲート**: `/verify-app` とスキルパイプラインの順序保証
- **監査ログ**: タスクごとに「割当理由」と「実行スキル」をサマリ化して記録
- **統合**: 成果物（レビュー/テスト結果/学び）をGitHubへ集約

### 1-2. 実行エージェント（Codex/Agent Teams）
- **担当範囲のみ変更**（ジョブパケットのスコープ厳守）
- **TDDサイクルの実行**（Red → Green → Refactor）
- **成果物の提出**（指定されたartifactsに保存）

---

## 2. ジョブパケットの仕様

ジョブパケットは `tasks/` のタスクファイルで管理する。以下が必須項目。

- **目的/受け入れ条件**: SpecのACと対応付け
- **依存関係**: 先行タスクを明記
- **変更範囲**: ファイル/モジュール単位で限定
- **成果物**: ログ・レビュー・出力ファイルの保存先
- **ハンドオフ**: 失敗時の次アクション（再割当 or エスカレーション）

---

## 3. 状態遷移（ステートマシン）

```
pending → in_progress → done
          ↘︎ blocked ↗︎
```

- **pending**: 未着手
- **in_progress**: 担当が確定し作業中（Lease開始）
- **blocked**: 依存関係・環境・設計不備で停止
- **done**: 受け入れ条件・テストが完了

### Lease（期限付き担当）
- 30分以上の無更新は**再割当候補**
- 停止が続く場合は `blocked` に変更し理由を記録

---

## 4. 実行ループ（オーケストレーション・サイクル）

1. **Spec更新**: 仕様変更が先
2. **タスク分解**: ジョブパケット作成
3. **割当**: 優先度・依存関係・負荷で配分
4. **実装**: TDDサイクル
5. **自己改善**: テスト失敗時は `skills/self-improve.md`
6. **成果物集約**: レビュー/テストログをGitHubに保存
7. **マネージャーログ記録**: 割当/スキル利用を `reports/manager-logs/` に記録
8. **統合検証**: `/verify-app`
9. **push & 学び**: CLAUDE.mdへ追記

---

## 5. 成果物の標準化

| 成果物 | 保存場所 | 形式 |
|--------|----------|------|
| テスト結果 | `reports/tests/` | コマンド/成否/ログ抜粋 |
| レビュー | `docs/reviews/` | 概要/指摘/提案 |
| 仕様差分 | `specs/` | 変更理由/影響範囲 |
| マネージャーログ | `reports/manager-logs/` | 割当理由/スキル利用/検証状況のサマリ |

### 5-1. マネージャーログ（割当・スキル監査）

ClaudeCode（マネージャー）は、各タスク完了時に以下を記録する。

- **Task ID / Spec ID**
- **最終担当**: 誰に割り当てたか（再割当があれば履歴も要約）
- **割当理由**: スコープ、難易度、依存関係に基づく判断
- **使用スキル（期待/実績）**: 期待したスキルと、実際に使われたスキル
- **検証結果**: 主要コマンドと pass/fail
- **未解決事項**: 次タスクに引き継ぐ論点

保存先は `reports/manager-logs/<date>-<task-id>.md` を推奨する。

---

## 6. 例外処理とエスカレーション

- **blocked** になったタスクは、原因と次アクションを明示
- 5回の自己改善ループで解決しない場合はIssue化
- スコープ拡大が必要なら**Spec更新 → 再分割**

---

## 7. 可視化と運用

- タスクファイルの `status` / `assignee` / `notes` が唯一の進捗
- 進捗共有は**タスク更新が優先**（チャットのみは禁止）
- 定期的に `specs/SPEC-INDEX.md` で整合性確認
