# AIエージェント オーケストレーション設計

このドキュメントは、複数エージェントを安定運用するための**実行ループ・役割分担・成果物管理**を定義する。

---

## 1. 役割と責務

### 1-1. オーケストレータ（ClaudeCode）
- **設計・分割**: Specから独立タスクを設計しジョブパケット化
- **割当**: 作業の重さに応じてClaudeCode/Codex/Agent Teamsへ配分
- **品質ゲート**: `/verify-app` とスキルパイプラインの順序保証
- **統合**: 成果物（レビュー/テスト結果/学び）をGitHubへ集約

### 1-2. 実行エージェント（Codex/Agent Teams）
- **担当範囲のみ変更**（ジョブパケットのスコープ厳守）
- **TDDサイクルの実行**（Red → Green → Refactor）
- **成果物の提出**（指定されたartifactsに保存）

---

## 2. ジョブパケットの仕様

ジョブパケットは `tasks/` のタスクファイルで管理する。以下が必須項目。

- **目的/受け入れ条件**: SpecのACと対応付け
- **依存関係**: 先行タスクを明記
- **変更範囲**: ファイル/モジュール単位で限定
- **成果物**: ログ・レビュー・出力ファイルの保存先
- **ハンドオフ**: 失敗時の次アクション（再割当 or エスカレーション）

---

## 3. 状態遷移（ステートマシン）

```
pending → in_progress → done
          ↘︎ blocked ↗︎
```

- **pending**: 未着手
- **in_progress**: 担当が確定し作業中（Lease開始）
- **blocked**: 依存関係・環境・設計不備で停止
- **done**: 受け入れ条件・テストが完了

### Lease（期限付き担当）
- 30分以上の無更新は**再割当候補**
- 停止が続く場合は `blocked` に変更し理由を記録

---

## 4. 実行ループ（オーケストレーション・サイクル）

1. **Spec更新**: 仕様変更が先
2. **タスク分解**: ジョブパケット作成
3. **割当**: 優先度・依存関係・負荷で配分
4. **実装**: TDDサイクル
5. **自己改善**: テスト失敗時は `skills/self-improve.md`
6. **成果物集約**: レビュー/テストログをGitHubに保存
7. **統合検証**: `/verify-app`
8. **push & 学び**: CLAUDE.mdへ追記

---

## 5. 成果物の標準化

| 成果物 | 保存場所 | 形式 |
|--------|----------|------|
| テスト結果 | `reports/tests/` | コマンド/成否/ログ抜粋 |
| レビュー | `docs/reviews/` | 概要/指摘/提案 |
| 仕様差分 | `specs/` | 変更理由/影響範囲 |

---

## 6. 例外処理とエスカレーション

- **blocked** になったタスクは、原因と次アクションを明示
- 5回の自己改善ループで解決しない場合はIssue化
- スコープ拡大が必要なら**Spec更新 → 再分割**

---

## 7. 可視化と運用

- タスクファイルの `status` / `assignee` / `notes` が唯一の進捗
- 進捗共有は**タスク更新が優先**（チャットのみは禁止）
- 定期的に `specs/SPEC-INDEX.md` で整合性確認

---

## 8. 優先度・WIP制御

### 優先度ルール
- **high**: 仕様差分・障害対応・リリース阻害要因
- **medium**: 価値提供に直結する通常開発
- **low**: 改善/リファクタリング/後追いドキュメント

同優先度が並ぶ場合は、`depends_on` が少ないタスクを先に処理して、待ち時間を減らす。

### WIP（Work In Progress）上限
- オーケストレータ（ClaudeCode）: **同時 in_progress は最大3件**
- Codex: **同時 in_progress は最大2件**
- Agent Teamサブエージェント: **1エージェント1件**

WIP超過時は新規着手せず、`blocked` 解消と `done` への完了を優先する。

---

## 9. 失敗時ランブック

### ケースA: タスクが長時間停滞
1. `notes` に直近試行と失敗理由を記録
2. `blocked` へ遷移し `blocked_reason` を記載
3. 再分割可能なら小粒タスクへ分割して `pending` で再登録

### ケースB: 検証失敗（/verify-app NG）
1. 失敗ログを `reports/tests/` に保存
2. `skills/self-improve.md` のループを最大5回実施
3. 未解決ならIssue化し、仕様不整合の有無をSpecへ反映

### ケースC: 競合多発
1. 競合ファイルを「共有資産」として専用タスク化
2. Single-writerで一時的に担当固定
3. 収束後に通常並列へ戻す

---

## 10. KPI（週次で観測）

- **Lead Time**: `pending` → `done` までの時間
- **Blocked Ratio**: `blocked` タスク数 / 全 in_progress
- **Verification Pass Rate**: `/verify-app` 一発成功率
- **Rework Rate**: `done` 後の差し戻し率

目安として、`Verification Pass Rate` が70%未満なら、タスク粒度か受け入れ条件の見直しを優先する。
