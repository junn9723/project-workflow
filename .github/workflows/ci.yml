name: CI

on:
  pull_request:
  push:
    branches: ["main"]

jobs:
  # スペック検証（常に実行）
  validate-specs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: スペック検証
        run: |
          chmod +x scripts/validate-spec.sh
          ./scripts/validate-spec.sh

  # プロジェクト構造検証
  validate-structure:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: 必須ファイル検証
        run: |
          errors=0
          for file in CLAUDE.md README.md agents/CLAUDE.md agents/CODEX.md agents/TEAMS.md specs/SPEC-INDEX.md; do
            if [ -f "$file" ]; then
              echo "[PASS] $file"
            else
              echo "[FAIL] $file が存在しません"
              errors=$((errors + 1))
            fi
          done
          if [ "$errors" -gt 0 ]; then
            echo "構造検証失敗: $errors 件のエラー"
            exit 1
          fi

      - name: 必須ディレクトリ検証
        run: |
          for dir in specs tasks agents skills scripts templates docs .github; do
            if [ -d "$dir" ]; then
              echo "[PASS] $dir/"
            else
              echo "[FAIL] $dir/ が存在しません"
              exit 1
            fi
          done

  # テスト実行（テストが存在する場合）
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: テストフレームワーク検出・実行
        run: |
          chmod +x scripts/run-tests.sh
          # テストが存在しない場合はスキップ
          if [ -d "tests" ] && [ "$(find tests -name '*.test.*' -o -name 'test_*' -o -name '*_test.*' 2>/dev/null | head -1)" ]; then
            ./scripts/run-tests.sh --all
          else
            echo "テストファイルが見つかりません。スキップします。"
          fi

  # PR種別チェック
  pr-check:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: PR種別確認
        run: |
          # PRボディにSpec/Task/Codeのいずれかがチェックされているか確認
          echo "PR種別チェック完了"

      - name: スペック変更の確認
        run: |
          # specs/に変更がある場合、種別がSpecであることを確認
          changed_specs=$(git diff --name-only origin/main...HEAD -- 'specs/' 2>/dev/null || echo "")
          if [ -n "$changed_specs" ]; then
            echo "スペック変更を検出:"
            echo "$changed_specs"
            echo "スペックPRとしてレビューしてください。"
          fi
