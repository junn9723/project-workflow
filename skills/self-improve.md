# Skill: self-improve（自己改善ループ）

## 目的
テスト失敗を起点に、原因分析→修正→再テストのサイクルを自律的に繰り返し、品質を向上させる。

## 前提条件
- テストが失敗している状態
- 対応するスペックが `specs/` に存在
- `test-run` スキルの実行結果（失敗レポート）がある

## 手順

### Step 1: 失敗の分類
テスト失敗を以下のカテゴリに分類:

| カテゴリ | 説明 | 対応 |
|----------|------|------|
| 実装バグ | ロジックエラー、タイポ等 | コード修正 |
| 設計不備 | アーキテクチャ上の問題 | リファクタリング |
| スペック不整合 | 仕様と実装の前提が異なる | スペック確認・更新 |
| テスト不備 | テスト自体が不正確 | テスト修正 |
| 依存問題 | 外部ライブラリ・環境の問題 | 依存更新・設定修正 |

### Step 2: 根本原因分析
1. 失敗テストのエラーメッセージを確認
2. スタックトレースから問題箇所を特定
3. 対応するスペックの受け入れ条件を再確認
4. 根本原因を1文で記述

### Step 3: 修正実施
カテゴリに応じた修正:

**実装バグの場合:**
1. 問題箇所を特定
2. 最小限の修正を実施
3. 関連する他のテストに影響がないことを確認

**設計不備の場合:**
1. 影響範囲を分析
2. リファクタリング計画を立案
3. 段階的に修正（テストが通る状態を維持）

**スペック不整合の場合:**
1. スペックと実装のどちらが正しいか判断
2. スペック更新が必要ならスペックを先に修正
3. 実装修正が必要なら修正を実施

### Step 4: 再テスト
1. 修正対象のテストを実行
2. 全テスト（回帰テスト）を実行
3. 結果を確認

### Step 5: ループ判定
```
修正 → テスト実行 → 成功? → Yes → 完了
                        ↓ No
                   ループ回数 < 上限(5回)?
                        ↓ Yes        ↓ No
                   Step 1に戻る    エスカレーション
```

**ループ上限**: 5回
**エスカレーション条件**: 5回修正しても解決しない場合、以下を実行:
1. これまでの試行を記録
2. 問題をIssueとして報告
3. 人間のレビューを依頼

### Step 6: 改善記録
修正内容を記録:
```
## 自己改善記録
- 日時: YYYY-MM-DD HH:MM
- 対象テスト: [テスト名]
- 分類: [カテゴリ]
- 根本原因: [原因]
- 修正内容: [変更概要]
- ループ回数: N
- 結果: 成功 / エスカレーション
```

## 判定基準
- **成功**: 全テストが通過（ループ上限内）
- **失敗**: ループ上限到達 → エスカレーション

## 出力
- 修正されたコード
- 自己改善記録（コミットメッセージに記載）
- エスカレーション時はIssue作成
