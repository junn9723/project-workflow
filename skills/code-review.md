# Skill: code-review（コード品質レビュー）

## 目的
コードの品質・保守性・セキュリティを自律的にレビューし、問題を検出・修正する。

## 前提条件
- 実装が完了し、テストが通過している状態
- 対応するスペックが `specs/` に存在

## 手順

### Step 1: 変更範囲の確認
1. `git diff main...HEAD` で変更差分を取得
2. 変更ファイル数・行数を確認
3. 対応するスペック・タスクを特定

### Step 2: コード品質チェック

#### 2-1. 可読性
- [ ] 命名規則が一貫しているか（プロジェクトの規約に従っているか）
- [ ] 関数/メソッドの責務が単一か
- [ ] ネストが深すぎないか（3段以下が目安）
- [ ] コメントが必要な箇所に適切なコメントがあるか
- [ ] マジックナンバーが定数化されているか

#### 2-2. 保守性
- [ ] DRY原則に従っているか（不要な重複がないか）
- [ ] 適切な抽象化レベルか（過剰抽象化でないか）
- [ ] 変更に強い設計か（ハードコードされた値がないか）
- [ ] エラーハンドリングが適切か

#### 2-3. セキュリティ（OWASP Top 10ベース）
- [ ] インジェクション脆弱性がないか（SQL, XSS, コマンド等）
- [ ] 認証・認可の処理が適切か
- [ ] 機密情報がハードコードされていないか
- [ ] 入力バリデーションが適切か
- [ ] 依存ライブラリに既知の脆弱性がないか

#### 2-4. パフォーマンス
- [ ] N+1問題がないか
- [ ] 不要なメモリ消費がないか
- [ ] 明らかな計算量の問題がないか

### Step 3: スペック準拠の確認
1. 変更がスペックの要件を満たしているか
2. スペックに記載のない機能を追加していないか
3. 受け入れ条件との対応関係が明確か

### Step 4: 問題の分類と対応

| 重要度 | 基準 | 対応 |
|--------|------|------|
| Critical | セキュリティ脆弱性・データ損失リスク | 即座に修正必須 |
| Major | バグ・設計上の重大な問題 | PR前に修正 |
| Minor | コード品質・可読性の問題 | 可能な範囲で修正 |
| Info | 改善提案・ベストプラクティス | 記録のみ |

### Step 5: レポート生成
```
## コードレビュー結果
- レビュー日時: YYYY-MM-DD HH:MM
- 対象: [ブランチ名 / PR番号]
- 変更規模: +N / -N 行

### 検出事項
| # | 重要度 | カテゴリ | ファイル:行 | 内容 |
|---|--------|----------|-------------|------|

### 総合判定: APPROVE / REQUEST_CHANGES
### 修正必要数: Critical: N, Major: N, Minor: N
```

## 判定基準
- **APPROVE**: Critical/Major が 0件
- **REQUEST_CHANGES**: Critical or Major が 1件以上

## 失敗時の対応
1. Critical → 即座に修正し再レビュー
2. Major → 修正し再レビュー
3. Minor → 可能な範囲で対応（ブロッキングではない）

## 出力
- コードレビューレポート
- Critical/Major の場合は修正済みコード
