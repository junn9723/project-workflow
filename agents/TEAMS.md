# Agent Teams 運用ガイド

## 概要

Agent Teamsは複数のAIエージェントが並列で開発を行うための連携フレームワーク。
GitHub上の情報を唯一のハブとし、コンフリクトを最小限に抑えながらスピード感のある開発を実現する。

## チーム構成

### メインエージェント: ClaudeCode
- **役割**: MVP開発・アーキテクチャ決定・スペック策定
- **権限**: スペック作成/更新、タスク分解、全コード変更
- **運用ガイド**: `agents/CLAUDE.md`

### サブエージェント: Codex
- **役割**: 並列タスク実行・コード実装
- **権限**: 割り当てられたタスクの実装のみ
- **運用ガイド**: `agents/CODEX.md`

### Agent Teams（ClaudeCode内の並列エージェント）
- **役割**: MVP開発時にClaudeCodeが内部的に並列実行するサブタスク群
- **権限**: 親エージェント（ClaudeCode）と同じだが、担当タスクに限定

## フェーズ別の運用

### Phase B: MVP開発（ClaudeCode + Agent Teams）

```
ClaudeCode (リーダー)
├── Agent 1: スペック→テスト変換
├── Agent 2: コア機能実装
├── Agent 3: インフラ・CI/CD構築
└── Agent 4: テスト実行・品質検証
```

**Agent Teams 活用のポイント**:
1. タスクを独立した単位に分解（ファイル/モジュール境界で分割）
2. 各Agentに明確なスコープを割り当て
3. 共有リソース（DB、設定ファイル等）への同時書き込みを避ける
4. 完了後にリーダーが統合・整合性確認

### Phase C: 並列開発（ClaudeCode + Codex + 人間）

```
GitHub (Hub)
├── ClaudeCode: 設計判断・複雑な実装・統合
├── Codex: 定型タスク・テスト追加・ドキュメント
└── Human: レビュー・承認・方向性決定
```

## タスク調整メカニズム

### 1. タスクの状態管理

タスクファイル（`tasks/`）で状態を管理:

```markdown
status: pending | in_progress | review | done
assignee: claude | codex | agent-team-N | human
branch: task/xxx-description
```

### 2. タスク取得ルール

1. `tasks/` から `status: pending` のタスクを確認
2. 依存関係（`depends_on`）が解決済みであることを確認
3. タスクファイルの `status` を `in_progress`、`assignee` を自分に更新
4. 専用ブランチを作成して実装開始

### 3. ロック機構（軽量版）

ファイルレベルのロックは行わない。代わりに:
- **タスク粒度の排他制御**: 1タスク = 1エージェントが原則
- **ブランチ分離**: 各タスクは独自ブランチで作業
- **スペック変更の優先**: スペックPRは実装PRより先にマージ

### 4. コンフリクト発生時の対応

1. **検出**: PRのCI/CDでマージコンフリクトを検出
2. **解決順序**: スペックPR → タスクPR → コードPRの優先度
3. **再ベース**: コンフリクト発生時はmainから再ベース
4. **分割**: 大きなコンフリクトはタスクを分割して解決

## Agent Teams でのタスク分解パターン

### パターン1: モジュール分割
```
Task: ユーザー認証機能
├── Agent 1: 認証API（auth/）
├── Agent 2: ユーザーモデル（models/user）
├── Agent 3: テスト（tests/auth/）
└── Agent 4: 設定・環境変数
```

### パターン2: レイヤー分割
```
Task: CRUD機能
├── Agent 1: データベース層
├── Agent 2: ビジネスロジック層
├── Agent 3: API層
└── Agent 4: フロントエンド層
```

### パターン3: TDDペア
```
Task: 機能実装
├── Agent 1: テスト作成（Red）
├── Agent 2: 実装（Green）
├── Agent 3: リファクタリング
└── Agent 4: 統合テスト・E2E
```

## コミュニケーション手段

- **GitHub Issues**: 議論・質問・決定事項の記録
- **PR Comments**: コードレビュー・技術的議論
- **タスクファイル**: 状態・進捗の共有
- **スペック変更PR**: 仕様変更の提案・承認

## 品質ゲート

### PR マージ前の必須チェック
1. CI/CDテスト全パス
2. スペック整合性検証（`scripts/validate-spec.sh`）
3. コードレビュー（人間 or エージェント）
4. 受け入れ条件チェックリスト完了

### マイルストーン完了時
1. 全スペックの受け入れ条件を再検証
2. 統合テスト実行
3. ベストプラクティス検証（`skills/best-practices.md`）
4. スペックインデックス更新
