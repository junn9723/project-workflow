# Agent Teams 運用ガイド

## 概要

Agent Teamsは複数のAIエージェントが並列で開発を行うための連携フレームワーク。
GitHub上の情報を唯一のハブとし、コンフリクトを最小限に抑えながらスピード感のある開発を実現する。

## チーム構成

### メインエージェント: ClaudeCode
- **役割**: MVP開発・アーキテクチャ決定・スペック策定
- **権限**: スペック作成/更新、タスク分解、全コード変更
- **運用ガイド**: `agents/CLAUDE.md`

### サブエージェント: Codex
- **役割**: 並列タスク実行・コード実装
- **権限**: 割り当てられたタスクの実装のみ
- **運用ガイド**: `agents/CODEX.md`

### Agent Teams（ClaudeCode内の並列エージェント）
- **役割**: MVP開発時にClaudeCodeが内部的に並列実行するサブタスク群
- **権限**: 親エージェント（ClaudeCode）と同じだが、担当タスクに限定

## フェーズ別の運用

### Phase B: MVP開発（ClaudeCode + Agent Teams）

```
ClaudeCode (リーダー)
├── Agent 1: スペック→テスト変換
├── Agent 2: コア機能実装
├── Agent 3: インフラ・CI/CD構築
└── Agent 4: テスト実行・品質検証
```

**Agent Teams 活用のポイント**:
1. タスクを独立した単位に分解（ファイル/モジュール境界で分割）
2. 各Agentに明確なスコープを割り当て
3. 共有リソース（DB、設定ファイル等）への同時書き込みを避ける
4. 完了後にリーダーが統合・整合性確認

### Phase C: 並列開発（ClaudeCode + Codex + 人間）

```
GitHub (Hub)
├── ClaudeCode: 設計判断・複雑な実装・統合
├── Codex: 定型タスク・テスト追加・ドキュメント
└── Human: レビュー・承認・方向性決定
```

## タスク調整メカニズム

### 1. タスクの状態管理

タスクファイル（`tasks/`）で状態を管理:

```markdown
status: pending | in_progress | done
assignee: claude | codex | agent-team-N | human
```

### 2. タスク取得ルール

1. `tasks/` から `status: pending` のタスクを確認
2. 依存関係（`depends_on`）が解決済みであることを確認
3. タスクファイルの `status` を `in_progress`、`assignee` を自分に更新
4. 実装開始

### 3. コンフリクト回避

- **タスク粒度の排他制御**: 1タスク = 1エージェントが原則
- **並列作業時**: ブランチ分離を推奨（コンフリクト回避）
- **スペック変更の優先**: スペック更新は実装より先に行う

### 4. コンフリクト発生時の対応

1. **検出**: push時またはCIでコンフリクトを検出
2. **解決順序**: スペック変更 → タスク変更 → コード変更の優先度
3. **再ベース**: コンフリクト発生時はmainから再ベース
4. **分割**: 大きなコンフリクトはタスクを分割して解決

## Agent Teams でのタスク分解パターン

### パターン1: モジュール分割
```
Task: ユーザー認証機能
├── Agent 1: 認証API（auth/）
├── Agent 2: ユーザーモデル（models/user）
├── Agent 3: テスト（tests/auth/）
└── Agent 4: 設定・環境変数
```

### パターン2: レイヤー分割
```
Task: CRUD機能
├── Agent 1: データベース層
├── Agent 2: ビジネスロジック層
├── Agent 3: API層
└── Agent 4: フロントエンド層
```

### パターン3: TDDペア
```
Task: 機能実装
├── Agent 1: テスト作成（Red）
├── Agent 2: 実装（Green）
├── Agent 3: リファクタリング
└── Agent 4: 統合テスト・E2E
```

## コミュニケーション手段

- **GitHub Issues**: 議論・質問・決定事項の記録
- **タスクファイル**: 状態・進捗の共有
- **スペック変更**: 仕様変更の提案・承認

## 並列セッション戦略

### 10〜20%の放棄を前提にする
全セッションが成功するわけではない。想定外で放棄されるセッションを織り込んで運用する。

**実践ルール:**
- タスクNに対して、N×1.2（切り上げ）のセッションを立てる
- 各セッションには明確な完了条件と検証手段を与える
- 30分以上進捗がないセッションは放棄候補
- 放棄時はタスクの `status` を `pending` に戻す（他が再取得可能に）

### 長時間タスクの運用
- バックグラウンドで実行し、完了時に `/verify-app` で自動検証
- 検証付きで放置するのが基本（検証なしの放置は禁止）
- VPS環境で実行し、サンドボックスで安全性を確保

## 学習サイクル

作業中に以下を実行:
1. 発見した「Claudeの失敗パターン」を特定
2. `/update-claude-md` でCLAUDE.mdのミスログに追記
3. 対策を記録（同じミスを繰り返さない仕組み）

**これはチームの集合知を蓄積する最重要サイクル。**

## 品質ゲート

### push前の必須チェック（検証ループ）
検証ループが成果物の品質を2〜3倍にする。省略は厳禁。

1. `/verify-app` 全パス（スペック検証・ユニット・E2E・ビルド）
2. コードレビュー（セルフレビュー or エージェント）
3. 受け入れ条件チェックリスト完了
4. CLAUDE.mdへの学び追記（該当する場合）

### マイルストーン完了時
1. 全スペックの受け入れ条件を再検証
2. E2E含む全テスト実行（`./scripts/run-tests.sh --all`）
3. ベストプラクティス検証（`skills/best-practices.md`）
4. スペックインデックス更新
5. CLAUDE.mdの整理・更新
